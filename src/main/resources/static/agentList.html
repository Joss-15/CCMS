<!DOCTYPE html>
<html lang="en">

<style>
    @import url('https://fonts.cdnfonts.com/css/caviar-dreams');
    table {
        border-collapse: collapse; /* Para evitar espacios entre celdas */
        background-color: #e6e6e6;
        width: 100%; /* Ancho completo de la tabla */
    }
    td {
        font-family: 'Trebuchet MS';
        border: 1px solid black; /* Borde de 1 píxel de ancho, sólido y de color negro */
        padding: 8px; /* Espaciado interno */
        text-align: left; /* Alineación del texto */
    }
    th {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-color: black;
        color: white;
        font-weight: bold;
        border: 1px solid black; /* Borde de 1 píxel de ancho, sólido y de color negro */
        padding: 8px; /* Espaciado interno */
        text-align: left; /* Alineación del texto */
    }
    input {
        font-style: italic;
    }
</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent List</title></head>
    <link rel="stylesheet" type="text/css" href="styles.css">
<body>
<h1 style="font-family: 'Caviar Dreams', sans-serif;">Agent List</h1>

<input type="text" id="codeFilter" placeholder="Filtrar por código">
<input type="text" id="nameFilter" placeholder="Filtrar por nombre">
<button onclick="window.location.href='index.html'">Add an agent</button>

<p></p>

<table id="agentsTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Code</th>
        <th>Name</th>
        <th>Supervisor</th>
        <th>ACM</th>
        <th>LOB</th>
        <th>Tenure</th>
        <th>Options</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
</body>


<script>
    const url = "http://localhost:8081/agents"
    populateTable();


    function populateTable(){
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const agentsTableBody = document.querySelector('#agentsTable tbody');
                data.forEach(agent => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${agent.id}</td>
                        <td>${agent.code}</td>
                        <td>${agent.name}</td>
                        <td>${agent.supervisor}</td>
                        <td>${agent.acm}</td>
                        <td>${agent.lob}</td>
                        <td>${agent.tenure}</td>
                        <td><button id="${agent.id}" onclick="deleteAgent(this)">Delete</button> <button id="${agent.id}" onclick="editAgent(this)">Edit</button> </td>
                    `;
                    row.setAttribute("id", agent.id);
                    agentsTableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error al obtener los datos de la API: ', error);
            });

    };


    document.getElementById('codeFilter').addEventListener('input', filterTable);
    document.getElementById('nameFilter').addEventListener('input', filterTable);

    function filterTable() {
        const codeFilter = document.getElementById('codeFilter').value.toUpperCase();
        const nameFilter = document.getElementById('nameFilter').value.toUpperCase();
        const rows = document.querySelectorAll('#agentsTable tbody tr');

        rows.forEach(row => {
            const code = row.cells[1].textContent.toUpperCase();
            const name = row.cells[2].textContent.toUpperCase();

            if (code.includes(codeFilter) && name.includes(nameFilter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }


    function deleteAgent(button){
        var row = button.parentNode.parentNode; // Obtiene la fila que contiene el botón
        var agentId = row.querySelector('td:first-child').textContent; // Obtiene el ID del estudiante de la primera celda de la fila
        buttonId = button.getAttribute('id');
        console.log(buttonId);


        // Elimina el estudiante de la base de datos a través de la API
        fetch(url + "/delete/id?id=" + agentId, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al eliminar el agente');
            }
            // Elimina la fila de la tabla en la interfaz de usuario después de eliminar el estudiante de la base de datos
            row.parentNode.removeChild(row);
            console.log('Agente eliminado exitosamente');
            alert("Se eliminó al agente exitosamente");
        })
        .catch(error => {
            console.error('Error al eliminar el agente: ', error);
            alert("Error al eliminar el agente");
        });
    }


    function editAgent(button){
        var row = button.parentNode.parentNode;
        var agente = row.querySelector('td:first-child').textContent;
        
        let codeCell = row.children.item(1);
        let nameCell = row.children.item(2);
        let supervisorCell = row.children.item(3);
        let acmCell = row.children.item(4);
        let lobCell = row.children.item(5);
        let tenureCell = row.children.item(6);
        

        codeCell.setAttribute("contenteditable", "true");
        nameCell.setAttribute("contenteditable", "true");
        supervisorCell.setAttribute("contenteditable", "true");
        acmCell.setAttribute("contenteditable", "true");
        lobCell.setAttribute("contenteditable", "true");
        tenureCell.setAttribute("contenteditable", "true");

        row.children.item(1).focus();

        let editButton = row.children.item(7).children.item(1);
        editButton.setAttribute("class","btn btn-success");
        editButton.innerHTML = "Save";

        editButton.setAttribute("onClick","saveAgent("+button.id+")");

    }

    function saveAgent(idButtonPress){

        let row = document.getElementById(idButtonPress);

        let idCell = row.children.item(0);
        let codeCell = row.children.item(1);
        let nameCell = row.children.item(2);
        let supervisorCell = row.children.item(3);
        let acmCell = row.children.item(4);
        let lobCell = row.children.item(5);
        let tenureCell = row.children.item(6);
        
        

        

        const AgentUpdated = {
            id : idCell.innerHTML,
            code : codeCell.innerHTML,
            name : nameCell.innerHTML,
            supervisor : supervisorCell.innerHTML,
            acm : acmCell.innerHTML,
            lob : lobCell.innerHTML,
            tenure : tenureCell.innerHTML
        };
        

        const requestOptions = {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(AgentUpdated)
        };

        const apiUrl = url + "/edit/" + idButtonPress

        fetch(apiUrl, requestOptions)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(studentFromAPI => {
                console.log('Success:', studentFromAPI);
                cleanTableRows();
                populateTable();
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error here
            });
    }

    function cleanTableRows() {
        var tableHeaderRowCount = 1;
        var table = document.getElementById('agentsTable');
        var rowCount = table.rows.length;
        for (var i = tableHeaderRowCount; i < rowCount; i++) {
            table.deleteRow(tableHeaderRowCount);
        }
    }

</script>


</html>